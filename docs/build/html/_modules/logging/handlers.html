



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>logging.handlers &mdash; fundamentals 0.1.4 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  

  
    <link rel="top" title="fundamentals 0.1.4 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> fundamentals
          

          
            
            <img src="../../_static/thespacedoctor_icon_white_circle.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">fundamentals</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>logging.handlers</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for logging.handlers</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2001-2010 by Vinay Sajip. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="c1"># documentation for any purpose and without fee is hereby granted,</span>
<span class="c1"># provided that the above copyright notice appear in all copies and that</span>
<span class="c1"># both that copyright notice and this permission notice appear in</span>
<span class="c1"># supporting documentation, and that the name of Vinay Sajip</span>
<span class="c1"># not be used in advertising or publicity pertaining to distribution</span>
<span class="c1"># of the software without specific, written prior permission.</span>
<span class="c1"># VINAY SAJIP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING</span>
<span class="c1"># ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL</span>
<span class="c1"># VINAY SAJIP BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR</span>
<span class="c1"># ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER</span>
<span class="c1"># IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="c1"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Additional handlers for the logging package for Python. The core package is</span>
<span class="sd">based on PEP 282 and comments thereto in comp.lang.python, and influenced by</span>
<span class="sd">Apache&#39;s log4j system.</span>

<span class="sd">Copyright (C) 2001-2010 Vinay Sajip. All Rights Reserved.</span>

<span class="sd">To use, simply &#39;import logging.handlers&#39; and log away!</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">cPickle</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">stat</span> <span class="kn">import</span> <span class="n">ST_DEV</span><span class="p">,</span> <span class="n">ST_INO</span><span class="p">,</span> <span class="n">ST_MTIME</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">codecs</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">codecs</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">unicode</span>
    <span class="n">_unicode</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">_unicode</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#</span>
<span class="c1"># Some constants...</span>
<span class="c1">#</span>

<span class="n">DEFAULT_TCP_LOGGING_PORT</span>    <span class="o">=</span> <span class="mi">9020</span>
<span class="n">DEFAULT_UDP_LOGGING_PORT</span>    <span class="o">=</span> <span class="mi">9021</span>
<span class="n">DEFAULT_HTTP_LOGGING_PORT</span>   <span class="o">=</span> <span class="mi">9022</span>
<span class="n">DEFAULT_SOAP_LOGGING_PORT</span>   <span class="o">=</span> <span class="mi">9023</span>
<span class="n">SYSLOG_UDP_PORT</span>             <span class="o">=</span> <span class="mi">514</span>
<span class="n">SYSLOG_TCP_PORT</span>             <span class="o">=</span> <span class="mi">514</span>

<span class="n">_MIDNIGHT</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># number of seconds in a day</span>

<span class="k">class</span> <span class="nc">BaseRotatingHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for handlers that rotate log files at a certain point.</span>
<span class="sd">    Not meant to be instantiated directly.  Instead, use RotatingFileHandler</span>
<span class="sd">    or TimedRotatingFileHandler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the specified filename for streamed logging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">codecs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Output the record to the file, catering for rollover as described</span>
<span class="sd">        in doRollover().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shouldRollover</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doRollover</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RotatingFileHandler</span><span class="p">(</span><span class="n">BaseRotatingHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for logging to a set of files, which switches from one file</span>
<span class="sd">    to the next when the current file reaches a certain size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the specified file and use it as the stream for logging.</span>

<span class="sd">        By default, the file grows indefinitely. You can specify particular</span>
<span class="sd">        values of maxBytes and backupCount to allow the file to rollover at</span>
<span class="sd">        a predetermined size.</span>

<span class="sd">        Rollover occurs whenever the current log file is nearly maxBytes in</span>
<span class="sd">        length. If backupCount is &gt;= 1, the system will successively create</span>
<span class="sd">        new files with the same pathname as the base file, but with extensions</span>
<span class="sd">        &quot;.1&quot;, &quot;.2&quot; etc. appended to it. For example, with a backupCount of 5</span>
<span class="sd">        and a base file name of &quot;app.log&quot;, you would get &quot;app.log&quot;,</span>
<span class="sd">        &quot;app.log.1&quot;, &quot;app.log.2&quot;, ... through to &quot;app.log.5&quot;. The file being</span>
<span class="sd">        written to is always &quot;app.log&quot; - when it gets filled up, it is closed</span>
<span class="sd">        and renamed to &quot;app.log.1&quot;, and if files &quot;app.log.1&quot;, &quot;app.log.2&quot; etc.</span>
<span class="sd">        exist, then they are renamed to &quot;app.log.2&quot;, &quot;app.log.3&quot; etc.</span>
<span class="sd">        respectively.</span>

<span class="sd">        If maxBytes is zero, rollover never occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If rotation/rollover is wanted, it doesn&#39;t make sense to use another</span>
        <span class="c1"># mode. If for example &#39;w&#39; were specified, then if there were multiple</span>
        <span class="c1"># runs of the calling application, the logs from previous runs would be</span>
        <span class="c1"># lost if the &#39;w&#39; is respected, because the log file would be truncated</span>
        <span class="c1"># on each run.</span>
        <span class="k">if</span> <span class="n">maxBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
        <span class="n">BaseRotatingHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxBytes</span> <span class="o">=</span> <span class="n">maxBytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span> <span class="o">=</span> <span class="n">backupCount</span>

    <span class="k">def</span> <span class="nf">doRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do a rollover, as described in __init__().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">sfn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">dfn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sfn</span><span class="p">):</span>
                    <span class="c1">#print &quot;%s -&gt; %s&quot; % (sfn, dfn)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dfn</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dfn</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">sfn</span><span class="p">,</span> <span class="n">dfn</span><span class="p">)</span>
            <span class="n">dfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span> <span class="o">+</span> <span class="s2">&quot;.1&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dfn</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dfn</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">,</span> <span class="n">dfn</span><span class="p">)</span>
            <span class="c1">#print &quot;%s -&gt; %s&quot; % (self.baseFilename, dfn)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shouldRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if rollover should occur.</span>

<span class="sd">        Basically, see if the supplied record would cause the file to exceed</span>
<span class="sd">        the size limit we have.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>                 <span class="c1"># delay was set...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                   <span class="c1"># are we rolling over?</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1">#due to non-posix-compliant Windows feature</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxBytes</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">TimedRotatingFileHandler</span><span class="p">(</span><span class="n">BaseRotatingHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for logging to a file, rotating the log file at certain timed</span>
<span class="sd">    intervals.</span>

<span class="sd">    If backupCount is &gt; 0, when rollover is done, no more than backupCount</span>
<span class="sd">    files are kept - the oldest ones are deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">BaseRotatingHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="n">when</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span> <span class="o">=</span> <span class="n">backupCount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utc</span> <span class="o">=</span> <span class="n">utc</span>
        <span class="c1"># Calculate the real rollover interval, which is just the number of</span>
        <span class="c1"># seconds between rollovers.  Also set the filename suffix used when</span>
        <span class="c1"># a rollover occurs.  Current &#39;when&#39; events supported:</span>
        <span class="c1"># S - Seconds</span>
        <span class="c1"># M - Minutes</span>
        <span class="c1"># H - Hours</span>
        <span class="c1"># D - Days</span>
        <span class="c1"># midnight - roll over at midnight</span>
        <span class="c1"># W{0-6} - roll over on a certain day; 0 - Monday</span>
        <span class="c1">#</span>
        <span class="c1"># Case of the &#39;when&#39; specifier is not important; lower or upper case</span>
        <span class="c1"># will work.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># one second</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="s2">r&quot;^\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}$&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># one minute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="s2">r&quot;^\d{4}-\d{2}-\d{2}_\d{2}-\d{2}$&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="c1"># one hour</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="s2">r&quot;^\d{4}-\d{2}-\d{2}_\d{2}$&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;MIDNIGHT&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1"># one day</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="s2">r&quot;^\d{4}-\d{2}-\d{2}$&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span> <span class="c1"># one week</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify a day for weekly rollover from 0 to 6 (0 is Monday): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;0&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid day specified for weekly rollover: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dayOfWeek</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="s2">r&quot;^\d{4}-\d{2}-\d{2}$&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid rollover interval specified: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">*</span> <span class="n">interval</span> <span class="c1"># multiply by units requested</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="n">ST_MTIME</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolloverAt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeRollover</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">computeRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentTime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Work out the rollover time based on the specified time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
        <span class="c1"># If we are rolling over at midnight or weekly, then the interval is already known.</span>
        <span class="c1"># What we need to figure out is WHEN the next interval is.  In other words,</span>
        <span class="c1"># if you are rolling over at midnight, then your base interval is 1 day,</span>
        <span class="c1"># but you want to start that one day clock at midnight, not now.  So, we</span>
        <span class="c1"># have to fudge the rolloverAt value in order to trigger the first rollover</span>
        <span class="c1"># at the right time.  After that, the regular interval will take care of</span>
        <span class="c1"># the rest.  Note that this code doesn&#39;t care about leap seconds. :)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;MIDNIGHT&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
            <span class="c1"># This could be done with less code, but I wanted it to be clear</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)</span>
            <span class="n">currentHour</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">currentMinute</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">currentSecond</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="c1"># r is the number of seconds left between now and midnight</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">_MIDNIGHT</span> <span class="o">-</span> <span class="p">((</span><span class="n">currentHour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">currentMinute</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span>
                    <span class="n">currentSecond</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">+</span> <span class="n">r</span>
            <span class="c1"># If we are rolling over on a certain day, add in the number of days until</span>
            <span class="c1"># the next rollover, but offset by 1 since we just calculated the time</span>
            <span class="c1"># until the next day starts.  There are three cases:</span>
            <span class="c1"># Case 1) The day to rollover is today; in this case, do nothing</span>
            <span class="c1"># Case 2) The day to rollover is further in the interval (i.e., today is</span>
            <span class="c1">#         day 2 (Wednesday) and rollover is on day 6 (Sunday).  Days to</span>
            <span class="c1">#         next rollover is simply 6 - 2 - 1, or 3.</span>
            <span class="c1"># Case 3) The day to rollover is behind us in the interval (i.e., today</span>
            <span class="c1">#         is day 5 (Saturday) and rollover is on day 3 (Thursday).</span>
            <span class="c1">#         Days to rollover is 6 - 5 + 3, or 4.  In this case, it&#39;s the</span>
            <span class="c1">#         number of days left in the current week (1) plus the number</span>
            <span class="c1">#         of days in the next week until the rollover day (3).</span>
            <span class="c1"># The calculations described in 2) and 3) above need to have a day added.</span>
            <span class="c1"># This is because the above time calculation takes us to midnight on this</span>
            <span class="c1"># day, i.e. the start of the next day.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="c1"># 0 is Monday</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayOfWeek</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">day</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayOfWeek</span><span class="p">:</span>
                        <span class="n">daysToWait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayOfWeek</span> <span class="o">-</span> <span class="n">day</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">daysToWait</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="n">day</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayOfWeek</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">daysToWait</span> <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
                        <span class="n">dstNow</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">dstAtRollover</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">newRolloverAt</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">dstNow</span> <span class="o">!=</span> <span class="n">dstAtRollover</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">dstNow</span><span class="p">:</span>  <span class="c1"># DST kicks in before next rollover, so we need to deduct an hour</span>
                                <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span> <span class="o">-</span> <span class="mi">3600</span>
                            <span class="k">else</span><span class="p">:</span>           <span class="c1"># DST bows out before next rollover, so we need to add an hour</span>
                                <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span> <span class="o">+</span> <span class="mi">3600</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">newRolloverAt</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">shouldRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if rollover should occur.</span>

<span class="sd">        record is not used, as we are just comparing times, but it is needed so</span>
<span class="sd">        the method signatures are the same</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolloverAt</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="c1">#print &quot;No need to rollover: %d, %d&quot; % (t, self.rolloverAt)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">getFilesToDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the files to delete when rolling over.</span>

<span class="sd">        More specific than the earlier method, which just used glob.glob().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dirName</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">)</span>
        <span class="n">fileNames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">baseName</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="n">plen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">fileNames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fileName</span><span class="p">[:</span><span class="n">plen</span><span class="p">]</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">fileName</span><span class="p">[</span><span class="n">plen</span><span class="p">:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extMatch</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">doRollover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        do a rollover; in this case, a date/time stamp is appended to the filename</span>
<span class="sd">        when the rollover happens.  However, you want the file to be named for the</span>
<span class="sd">        start of the interval, not the current time.  If there is a backup count,</span>
<span class="sd">        then we have to get a list of matching filenames, sort them and remove</span>
<span class="sd">        the one with the oldest suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># get the time that this sequence started at and make it a TimeTuple</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolloverAt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
            <span class="n">timeTuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeTuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">dfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">timeTuple</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dfn</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dfn</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">,</span> <span class="n">dfn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># find the oldest log file and delete it</span>
            <span class="c1">#s = glob.glob(self.baseFilename + &quot;.20*&quot;)</span>
            <span class="c1">#if len(s) &gt; self.backupCount:</span>
            <span class="c1">#    s.sort()</span>
            <span class="c1">#    os.remove(s[0])</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFilesToDelete</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1">#print &quot;%s -&gt; %s&quot; % (self.baseFilename, dfn)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>
        <span class="n">currentTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeRollover</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">newRolloverAt</span> <span class="o">&lt;=</span> <span class="n">currentTime</span><span class="p">:</span>
            <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
        <span class="c1">#If DST changes and midnight or weekly rollover, adjust for this.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">when</span> <span class="o">==</span> <span class="s1">&#39;MIDNIGHT&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">when</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">utc</span><span class="p">:</span>
            <span class="n">dstNow</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">currentTime</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dstAtRollover</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">newRolloverAt</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dstNow</span> <span class="o">!=</span> <span class="n">dstAtRollover</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dstNow</span><span class="p">:</span>  <span class="c1"># DST kicks in before next rollover, so we need to deduct an hour</span>
                    <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span> <span class="o">-</span> <span class="mi">3600</span>
                <span class="k">else</span><span class="p">:</span>           <span class="c1"># DST bows out before next rollover, so we need to add an hour</span>
                    <span class="n">newRolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span> <span class="o">+</span> <span class="mi">3600</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolloverAt</span> <span class="o">=</span> <span class="n">newRolloverAt</span>

<span class="k">class</span> <span class="nc">WatchedFileHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler for logging to a file, which watches the file</span>
<span class="sd">    to see if it has changed while in use. This can happen because of</span>
<span class="sd">    usage of programs such as newsyslog and logrotate which perform</span>
<span class="sd">    log file rotation. This handler, intended for use under Unix,</span>
<span class="sd">    watches the file to see if it has changed since the last emit.</span>
<span class="sd">    (A file has changed if its device or inode have changed.)</span>
<span class="sd">    If it has changed, the old file stream is closed, and the file</span>
<span class="sd">    opened to get a new stream.</span>

<span class="sd">    This handler is not appropriate for use under Windows, because</span>
<span class="sd">    under Windows open files cannot be moved or renamed - logging</span>
<span class="sd">    opens the files with exclusive locks - and so there is no need</span>
<span class="sd">    for such a handler. Furthermore, ST_INO is not supported under</span>
<span class="sd">    Windows; stat always returns zero for this value.</span>

<span class="sd">    This handler is based on a suggestion and patch by Chad J.</span>
<span class="sd">    Schroeder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ino</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">ST_DEV</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="n">ST_INO</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        First check if the underlying file has changed, and if it</span>
<span class="sd">        has, close the old stream and reopen the file to get the</span>
<span class="sd">        current stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">):</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">ST_DEV</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">ST_INO</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ino</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">changed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseFilename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ino</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">ST_DEV</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="n">ST_INO</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SocketHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which writes logging records, in pickle format, to</span>
<span class="sd">    a streaming socket. The socket is kept open across logging calls.</span>
<span class="sd">    If the peer resets it, an attempt is made to reconnect on the next call.</span>
<span class="sd">    The pickle which is sent is that of the LogRecord&#39;s attribute dictionary</span>
<span class="sd">    (__dict__), so that the receiver does not need to have the logging module</span>
<span class="sd">    installed in order to process the logging event.</span>

<span class="sd">    To unpickle the record at the receiving end into a LogRecord, use the</span>
<span class="sd">    makeLogRecord function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the handler with a specific host address and port.</span>

<span class="sd">        The attribute &#39;closeOnError&#39; is set to 1 - which means that if</span>
<span class="sd">        a socket error occurs, the socket is silently closed and then</span>
<span class="sd">        reopened on the next logging call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeOnError</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#</span>
        <span class="c1"># Exponential backoff parameters.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retryStart</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retryMax</span> <span class="o">=</span> <span class="mf">30.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retryFactor</span> <span class="o">=</span> <span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">makeSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A factory method which allows subclasses to define the precise</span>
<span class="sd">        type of socket they want.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;settimeout&#39;</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">createSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to create a socket, using an exponential backoff with</span>
<span class="sd">        a max retry time. Thanks to Robert Olson for the original patch</span>
<span class="sd">        (SF #815911) which has been slightly refactored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Either retryTime is None, in which case this</span>
        <span class="c1"># is the first time back after a disconnect, or</span>
        <span class="c1"># we&#39;ve waited long enough.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attempt</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeSocket</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># next time, no delay before trying</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="c1">#Creation failed, so set the retry time and return.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryStart</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryFactor</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryMax</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryMax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retryTime</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">retryPeriod</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a pickled string to the socket.</span>

<span class="sd">        This function allows for partial sends which can happen when the</span>
<span class="sd">        network is busy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createSocket</span><span class="p">()</span>
        <span class="c1">#self.sock can be None either because we haven&#39;t reached the retry</span>
        <span class="c1">#time yet, or because we have reached the retry time and retried,</span>
        <span class="c1">#but are still unable to connect.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&quot;sendall&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sentsofar</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">while</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">sentsofar</span><span class="p">:])</span>
                        <span class="n">sentsofar</span> <span class="o">=</span> <span class="n">sentsofar</span> <span class="o">+</span> <span class="n">sent</span>
                        <span class="n">left</span> <span class="o">=</span> <span class="n">left</span> <span class="o">-</span> <span class="n">sent</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># so we can call createSocket next time</span>

    <span class="k">def</span> <span class="nf">makePickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pickles the record in binary format with a length prefix, and</span>
<span class="sd">        returns it ready for transmission across the socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_info</span>
        <span class="k">if</span> <span class="n">ei</span><span class="p">:</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="c1"># just to get traceback text into record.exc_text</span>
            <span class="n">record</span><span class="o">.</span><span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># to avoid Unpickleable error</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">__dict__</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ei</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">exc_info</span> <span class="o">=</span> <span class="n">ei</span>  <span class="c1"># for next handler</span>
        <span class="n">slen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;L&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">slen</span> <span class="o">+</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">handleError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle an error during logging.</span>

<span class="sd">        An error has occurred during logging. Most likely cause -</span>
<span class="sd">        connection lost. Close the socket so that we can retry on the</span>
<span class="sd">        next event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closeOnError</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>        <span class="c1">#try to reconnect next time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Pickles the record and writes it to the socket in binary format.</span>
<span class="sd">        If there is an error with the socket, silently drop the packet.</span>
<span class="sd">        If there was a problem with the socket, re-establishes the</span>
<span class="sd">        socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePickle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DatagramHandler</span><span class="p">(</span><span class="n">SocketHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which writes logging records, in pickle format, to</span>
<span class="sd">    a datagram socket.  The pickle which is sent is that of the LogRecord&#39;s</span>
<span class="sd">    attribute dictionary (__dict__), so that the receiver does not need to</span>
<span class="sd">    have the logging module installed in order to process the logging event.</span>

<span class="sd">    To unpickle the record at the receiving end into a LogRecord, use the</span>
<span class="sd">    makeLogRecord function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the handler with a specific host address and port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SocketHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closeOnError</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">makeSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The factory method of SocketHandler is here overridden to create</span>
<span class="sd">        a UDP socket (SOCK_DGRAM).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a pickled string to a socket.</span>

<span class="sd">        This function no longer allows for partial sends which can happen</span>
<span class="sd">        when the network is busy - UDP does not guarantee delivery and</span>
<span class="sd">        can deliver packets out of sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createSocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">SysLogHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which sends formatted logging records to a syslog</span>
<span class="sd">    server. Based on Sam Rushing&#39;s syslog module:</span>
<span class="sd">    http://www.nightmare.com/squirl/python-ext/misc/syslog.py</span>
<span class="sd">    Contributed by Nicolas Untz (after which minor refactoring changes</span>
<span class="sd">    have been made).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from &lt;linux/sys/syslog.h&gt;:</span>
    <span class="c1"># ======================================================================</span>
    <span class="c1"># priorities/facilities are encoded into a single 32-bit quantity, where</span>
    <span class="c1"># the bottom 3 bits are the priority (0-7) and the top 28 bits are the</span>
    <span class="c1"># facility (0-big number). Both the priorities and the facilities map</span>
    <span class="c1"># roughly one-to-one to strings in the syslogd(8) source code.  This</span>
    <span class="c1"># mapping is included in this file.</span>
    <span class="c1">#</span>
    <span class="c1"># priorities (these are ordered)</span>

    <span class="n">LOG_EMERG</span>     <span class="o">=</span> <span class="mi">0</span>       <span class="c1">#  system is unusable</span>
    <span class="n">LOG_ALERT</span>     <span class="o">=</span> <span class="mi">1</span>       <span class="c1">#  action must be taken immediately</span>
    <span class="n">LOG_CRIT</span>      <span class="o">=</span> <span class="mi">2</span>       <span class="c1">#  critical conditions</span>
    <span class="n">LOG_ERR</span>       <span class="o">=</span> <span class="mi">3</span>       <span class="c1">#  error conditions</span>
    <span class="n">LOG_WARNING</span>   <span class="o">=</span> <span class="mi">4</span>       <span class="c1">#  warning conditions</span>
    <span class="n">LOG_NOTICE</span>    <span class="o">=</span> <span class="mi">5</span>       <span class="c1">#  normal but significant condition</span>
    <span class="n">LOG_INFO</span>      <span class="o">=</span> <span class="mi">6</span>       <span class="c1">#  informational</span>
    <span class="n">LOG_DEBUG</span>     <span class="o">=</span> <span class="mi">7</span>       <span class="c1">#  debug-level messages</span>

    <span class="c1">#  facility codes</span>
    <span class="n">LOG_KERN</span>      <span class="o">=</span> <span class="mi">0</span>       <span class="c1">#  kernel messages</span>
    <span class="n">LOG_USER</span>      <span class="o">=</span> <span class="mi">1</span>       <span class="c1">#  random user-level messages</span>
    <span class="n">LOG_MAIL</span>      <span class="o">=</span> <span class="mi">2</span>       <span class="c1">#  mail system</span>
    <span class="n">LOG_DAEMON</span>    <span class="o">=</span> <span class="mi">3</span>       <span class="c1">#  system daemons</span>
    <span class="n">LOG_AUTH</span>      <span class="o">=</span> <span class="mi">4</span>       <span class="c1">#  security/authorization messages</span>
    <span class="n">LOG_SYSLOG</span>    <span class="o">=</span> <span class="mi">5</span>       <span class="c1">#  messages generated internally by syslogd</span>
    <span class="n">LOG_LPR</span>       <span class="o">=</span> <span class="mi">6</span>       <span class="c1">#  line printer subsystem</span>
    <span class="n">LOG_NEWS</span>      <span class="o">=</span> <span class="mi">7</span>       <span class="c1">#  network news subsystem</span>
    <span class="n">LOG_UUCP</span>      <span class="o">=</span> <span class="mi">8</span>       <span class="c1">#  UUCP subsystem</span>
    <span class="n">LOG_CRON</span>      <span class="o">=</span> <span class="mi">9</span>       <span class="c1">#  clock daemon</span>
    <span class="n">LOG_AUTHPRIV</span>  <span class="o">=</span> <span class="mi">10</span>      <span class="c1">#  security/authorization messages (private)</span>
    <span class="n">LOG_FTP</span>       <span class="o">=</span> <span class="mi">11</span>      <span class="c1">#  FTP daemon</span>

    <span class="c1">#  other codes through 15 reserved for system use</span>
    <span class="n">LOG_LOCAL0</span>    <span class="o">=</span> <span class="mi">16</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL1</span>    <span class="o">=</span> <span class="mi">17</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL2</span>    <span class="o">=</span> <span class="mi">18</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL3</span>    <span class="o">=</span> <span class="mi">19</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL4</span>    <span class="o">=</span> <span class="mi">20</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL5</span>    <span class="o">=</span> <span class="mi">21</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL6</span>    <span class="o">=</span> <span class="mi">22</span>      <span class="c1">#  reserved for local use</span>
    <span class="n">LOG_LOCAL7</span>    <span class="o">=</span> <span class="mi">23</span>      <span class="c1">#  reserved for local use</span>

    <span class="n">priority_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;alert&quot;</span><span class="p">:</span>    <span class="n">LOG_ALERT</span><span class="p">,</span>
        <span class="s2">&quot;crit&quot;</span><span class="p">:</span>     <span class="n">LOG_CRIT</span><span class="p">,</span>
        <span class="s2">&quot;critical&quot;</span><span class="p">:</span> <span class="n">LOG_CRIT</span><span class="p">,</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span>    <span class="n">LOG_DEBUG</span><span class="p">,</span>
        <span class="s2">&quot;emerg&quot;</span><span class="p">:</span>    <span class="n">LOG_EMERG</span><span class="p">,</span>
        <span class="s2">&quot;err&quot;</span><span class="p">:</span>      <span class="n">LOG_ERR</span><span class="p">,</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span>    <span class="n">LOG_ERR</span><span class="p">,</span>        <span class="c1">#  DEPRECATED</span>
        <span class="s2">&quot;info&quot;</span><span class="p">:</span>     <span class="n">LOG_INFO</span><span class="p">,</span>
        <span class="s2">&quot;notice&quot;</span><span class="p">:</span>   <span class="n">LOG_NOTICE</span><span class="p">,</span>
        <span class="s2">&quot;panic&quot;</span><span class="p">:</span>    <span class="n">LOG_EMERG</span><span class="p">,</span>      <span class="c1">#  DEPRECATED</span>
        <span class="s2">&quot;warn&quot;</span><span class="p">:</span>     <span class="n">LOG_WARNING</span><span class="p">,</span>    <span class="c1">#  DEPRECATED</span>
        <span class="s2">&quot;warning&quot;</span><span class="p">:</span>  <span class="n">LOG_WARNING</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">facility_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;auth&quot;</span><span class="p">:</span>     <span class="n">LOG_AUTH</span><span class="p">,</span>
        <span class="s2">&quot;authpriv&quot;</span><span class="p">:</span> <span class="n">LOG_AUTHPRIV</span><span class="p">,</span>
        <span class="s2">&quot;cron&quot;</span><span class="p">:</span>     <span class="n">LOG_CRON</span><span class="p">,</span>
        <span class="s2">&quot;daemon&quot;</span><span class="p">:</span>   <span class="n">LOG_DAEMON</span><span class="p">,</span>
        <span class="s2">&quot;ftp&quot;</span><span class="p">:</span>      <span class="n">LOG_FTP</span><span class="p">,</span>
        <span class="s2">&quot;kern&quot;</span><span class="p">:</span>     <span class="n">LOG_KERN</span><span class="p">,</span>
        <span class="s2">&quot;lpr&quot;</span><span class="p">:</span>      <span class="n">LOG_LPR</span><span class="p">,</span>
        <span class="s2">&quot;mail&quot;</span><span class="p">:</span>     <span class="n">LOG_MAIL</span><span class="p">,</span>
        <span class="s2">&quot;news&quot;</span><span class="p">:</span>     <span class="n">LOG_NEWS</span><span class="p">,</span>
        <span class="s2">&quot;security&quot;</span><span class="p">:</span> <span class="n">LOG_AUTH</span><span class="p">,</span>       <span class="c1">#  DEPRECATED</span>
        <span class="s2">&quot;syslog&quot;</span><span class="p">:</span>   <span class="n">LOG_SYSLOG</span><span class="p">,</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span>     <span class="n">LOG_USER</span><span class="p">,</span>
        <span class="s2">&quot;uucp&quot;</span><span class="p">:</span>     <span class="n">LOG_UUCP</span><span class="p">,</span>
        <span class="s2">&quot;local0&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL0</span><span class="p">,</span>
        <span class="s2">&quot;local1&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL1</span><span class="p">,</span>
        <span class="s2">&quot;local2&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL2</span><span class="p">,</span>
        <span class="s2">&quot;local3&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL3</span><span class="p">,</span>
        <span class="s2">&quot;local4&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL4</span><span class="p">,</span>
        <span class="s2">&quot;local5&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL5</span><span class="p">,</span>
        <span class="s2">&quot;local6&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL6</span><span class="p">,</span>
        <span class="s2">&quot;local7&quot;</span><span class="p">:</span>   <span class="n">LOG_LOCAL7</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1">#The map below appears to be trivially lowercasing the key. However,</span>
    <span class="c1">#there&#39;s more to it than meets the eye - in some locales, lowercasing</span>
    <span class="c1">#gives unexpected results. See SF #1524081: in the Turkish locale,</span>
    <span class="c1">#&quot;INFO&quot;.lower() != &quot;info&quot;</span>
    <span class="n">priority_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;DEBUG&quot;</span> <span class="p">:</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INFO&quot;</span> <span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WARNING&quot;</span> <span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ERROR&quot;</span> <span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CRITICAL&quot;</span> <span class="p">:</span> <span class="s2">&quot;critical&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">SYSLOG_UDP_PORT</span><span class="p">),</span>
                 <span class="n">facility</span><span class="o">=</span><span class="n">LOG_USER</span><span class="p">,</span> <span class="n">socktype</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a handler.</span>

<span class="sd">        If address is specified as a string, a UNIX socket is used. To log to a</span>
<span class="sd">        local syslogd, &quot;SysLogHandler(address=&quot;/dev/log&quot;)&quot; can be used.</span>
<span class="sd">        If facility is not specified, LOG_USER is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facility</span> <span class="o">=</span> <span class="n">facility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socktype</span> <span class="o">=</span> <span class="n">socktype</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unixsocket</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_unixsocket</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unixsocket</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">socktype</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_connect_unixsocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="c1"># syslog may require either DGRAM or STREAM sockets</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

    <span class="c1"># curious: when talking to the unix-domain &#39;/dev/log&#39; socket, a</span>
    <span class="c1">#   zero-terminator seems to be required.  this string is placed</span>
    <span class="c1">#   into a class variable so that it can be overridden if</span>
    <span class="c1">#   necessary.</span>
    <span class="n">log_format_string</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">%d</span><span class="s1">&gt;</span><span class="si">%s</span><span class="se">\000</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">encodePriority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode the facility and priority. You can pass in strings or</span>
<span class="sd">        integers - if strings are passed, the facility_names and</span>
<span class="sd">        priority_names mapping dictionaries are used to convert them to</span>
<span class="sd">        integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facility</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">facility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facility_names</span><span class="p">[</span><span class="n">facility</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_names</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">facility</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">priority</span>

    <span class="k">def</span> <span class="nf">close</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unixsocket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mapPriority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levelName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map a logging level name to a key in the priority_names map.</span>
<span class="sd">        This is useful in two scenarios: when custom levels are being</span>
<span class="sd">        used, and in the case where you can&#39;t do a straightforward</span>
<span class="sd">        mapping by lowercasing the logging level name because of locale-</span>
<span class="sd">        specific issues (see SF #1524081).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">levelName</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        The record is formatted, and then sent to the syslog server. If</span>
<span class="sd">        exception information is present, it is NOT sent to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\000</span><span class="s1">&#39;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We need to convert record level to lowercase, maybe this will</span>
<span class="sd">        change in the future.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prio</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">%d</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encodePriority</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facility</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">mapPriority</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">))</span>
        <span class="c1"># Message is a string. Convert to bytes as required by RFC 5424</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">unicode</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">codecs</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF8</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">prio</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unixsocket</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_connect_unixsocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">socktype</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SMTPHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which sends an SMTP email for each logging event.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mailhost</span><span class="p">,</span> <span class="n">fromaddr</span><span class="p">,</span> <span class="n">toaddrs</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span>
                 <span class="n">credentials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the handler.</span>

<span class="sd">        Initialize the instance with the from and to addresses and subject</span>
<span class="sd">        line of the email. To specify a non-standard SMTP port, use the</span>
<span class="sd">        (host, port) tuple format for the mailhost argument. To specify</span>
<span class="sd">        authentication credentials, supply a (username, password) tuple</span>
<span class="sd">        for the credentials argument. To specify the use of a secure</span>
<span class="sd">        protocol (TLS), pass in a tuple for the secure argument. This will</span>
<span class="sd">        only be used when authentication credentials are supplied. The tuple</span>
<span class="sd">        will be either an empty tuple, or a single-value tuple with the name</span>
<span class="sd">        of a keyfile, or a 2-value tuple with the names of the keyfile and</span>
<span class="sd">        certificate file. (This tuple is passed to the `starttls` method).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mailhost</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mailhost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailport</span> <span class="o">=</span> <span class="n">mailhost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mailhost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailport</span> <span class="o">=</span> <span class="n">mailhost</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">credentials</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">credentials</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fromaddr</span> <span class="o">=</span> <span class="n">fromaddr</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toaddrs</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">toaddrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">toaddrs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toaddrs</span> <span class="o">=</span> <span class="n">toaddrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span>

    <span class="k">def</span> <span class="nf">getSubject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the subject for the email.</span>

<span class="sd">        If you want to specify a subject line which is record-dependent,</span>
<span class="sd">        override this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Format the record and send it to the specified addressees.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">smtplib</span>
            <span class="kn">from</span> <span class="nn">email.utils</span> <span class="kn">import</span> <span class="n">formatdate</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailport</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_PORT</span>
            <span class="n">smtp</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mailhost</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">Subject: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">Date: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fromaddr</span><span class="p">,</span>
                            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toaddrs</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">getSubject</span><span class="p">(</span><span class="n">record</span><span class="p">),</span>
                            <span class="n">formatdate</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">smtp</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
                    <span class="n">smtp</span><span class="o">.</span><span class="n">starttls</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">secure</span><span class="p">)</span>
                    <span class="n">smtp</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
                <span class="n">smtp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
            <span class="n">smtp</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fromaddr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toaddrs</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">smtp</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NTEventLogHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which sends events to the NT Event Log. Adds a</span>
<span class="sd">    registry entry for the specified application name. If no dllname is</span>
<span class="sd">    provided, win32service.pyd (which contains some basic message</span>
<span class="sd">    placeholders) is used. Note that use of these placeholders will make</span>
<span class="sd">    your event logs big, as the entire message source is held in the log.</span>
<span class="sd">    If you want slimmer logs, you have to pass in the name of your own DLL</span>
<span class="sd">    which contains the message definitions you want to use in the event log.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appname</span><span class="p">,</span> <span class="n">dllname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logtype</span><span class="o">=</span><span class="s2">&quot;Application&quot;</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">win32evtlogutil</span><span class="o">,</span> <span class="nn">win32evtlog</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appname</span> <span class="o">=</span> <span class="n">appname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_welu</span> <span class="o">=</span> <span class="n">win32evtlogutil</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dllname</span><span class="p">:</span>
                <span class="n">dllname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_welu</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
                <span class="n">dllname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dllname</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dllname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dllname</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">r&#39;win32service.pyd&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dllname</span> <span class="o">=</span> <span class="n">dllname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logtype</span> <span class="o">=</span> <span class="n">logtype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_welu</span><span class="o">.</span><span class="n">AddSourceToRegistry</span><span class="p">(</span><span class="n">appname</span><span class="p">,</span> <span class="n">dllname</span><span class="p">,</span> <span class="n">logtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deftype</span> <span class="o">=</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_ERROR_TYPE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typemap</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>   <span class="p">:</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_INFORMATION_TYPE</span><span class="p">,</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>    <span class="p">:</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_INFORMATION_TYPE</span><span class="p">,</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span> <span class="p">:</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_WARNING_TYPE</span><span class="p">,</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>   <span class="p">:</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_ERROR_TYPE</span><span class="p">,</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span> <span class="n">win32evtlog</span><span class="o">.</span><span class="n">EVENTLOG_ERROR_TYPE</span><span class="p">,</span>
         <span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The Python Win32 extensions for NT (service, event &quot;</span>\
                        <span class="s2">&quot;logging) appear not to be available.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_welu</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">getMessageID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the message ID for the event record. If you are using your</span>
<span class="sd">        own messages, you could do this by having the msg passed to the</span>
<span class="sd">        logger being an ID rather than a formatting string. Then, in here,</span>
<span class="sd">        you could use a dictionary lookup to get the message ID. This</span>
<span class="sd">        version returns 1, which is the base message ID in win32service.pyd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">getEventCategory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the event category for the record.</span>

<span class="sd">        Override this if you want to specify your own categories. This version</span>
<span class="sd">        returns 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">getEventType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the event type for the record.</span>

<span class="sd">        Override this if you want to specify your own types. This version does</span>
<span class="sd">        a mapping using the handler&#39;s typemap attribute, which is set up in</span>
<span class="sd">        __init__() to a dictionary which contains mappings for DEBUG, INFO,</span>
<span class="sd">        WARNING, ERROR and CRITICAL. If you are using your own levels you will</span>
<span class="sd">        either need to override this method or place a suitable dictionary in</span>
<span class="sd">        the handler&#39;s typemap attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typemap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deftype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Determine the message ID, event category and event type. Then</span>
<span class="sd">        log the message in the NT event log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_welu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMessageID</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEventCategory</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEventType</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_welu</span><span class="o">.</span><span class="n">ReportEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appname</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="p">[</span><span class="n">msg</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up this handler.</span>

<span class="sd">        You can remove the application name from the registry as a</span>
<span class="sd">        source of event log entries. However, if you do this, you will</span>
<span class="sd">        not be able to see the events as you intended in the Event Log</span>
<span class="sd">        Viewer - it needs to be able to access the registry to get the</span>
<span class="sd">        DLL name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self._welu.RemoveSourceFromRegistry(self.appname, self.logtype)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HTTPHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which sends records to a Web server, using either GET or</span>
<span class="sd">    POST semantics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the instance with the host, the request URL, and the method</span>
<span class="sd">        (&quot;GET&quot; or &quot;POST&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method must be GET or POST&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="nf">mapLogRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default implementation of mapping the log record into a dict</span>
<span class="sd">        that is sent as the CGI data. Overwrite in your class.</span>
<span class="sd">        Contributed by Franz  Glasner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Send the record to the Web server as a percent-encoded dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">httplib</span><span class="o">,</span> <span class="nn">urllib</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTP</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapLogRecord</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%c%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">putrequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="c1"># support multiple hosts on one IP address...</span>
            <span class="c1"># need to strip optional :port from host, if present</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">h</span><span class="o">.</span><span class="n">putheader</span><span class="p">(</span><span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">putheader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">putheader</span><span class="p">(</span><span class="s2">&quot;Content-length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
            <span class="n">h</span><span class="o">.</span><span class="n">endheaders</span><span class="p">(</span><span class="n">data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">getreply</span><span class="p">()</span>    <span class="c1">#can&#39;t do anything with the result</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleError</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BufferingHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A handler class which buffers logging records in memory. Whenever each</span>
<span class="sd">  record is added to the buffer, a check is made to see if the buffer should</span>
<span class="sd">  be flushed. If it should, then flush() is expected to do what&#39;s needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the handler with the buffer size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Should the handler flush its buffer?</span>

<span class="sd">        Returns true if the buffer is up to capacity. This method can be</span>
<span class="sd">        overridden to implement custom flushing strategies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit a record.</span>

<span class="sd">        Append the record. If shouldFlush() tells us to, call flush() to process</span>
<span class="sd">        the buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shouldFlush</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override to implement custom flushing behaviour.</span>

<span class="sd">        This version just zaps the buffer to empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the handler.</span>

<span class="sd">        This version just flushes and chains to the parent class&#39; close().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MemoryHandler</span><span class="p">(</span><span class="n">BufferingHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler class which buffers logging records in memory, periodically</span>
<span class="sd">    flushing them to a target handler. Flushing occurs whenever the buffer</span>
<span class="sd">    is full, or when an event of a certain severity or greater is seen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">flushLevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the handler with the buffer size, the level at which</span>
<span class="sd">        flushing should occur and an optional target.</span>

<span class="sd">        Note that without a target being set either here or via setTarget(),</span>
<span class="sd">        a MemoryHandler is no use to anyone!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BufferingHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flushLevel</span> <span class="o">=</span> <span class="n">flushLevel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for buffer full or a record at the flushLevel or higher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flushLevel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setTarget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the target handler for this handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a MemoryHandler, flushing means just sending the buffered</span>
<span class="sd">        records to the target, if there is one. Override if you want</span>
<span class="sd">        different behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flush, set the target to None and lose the buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">BufferingHandler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Dave Young.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>